import Head from 'next/head'
import { ThemeProvider } from 'styled-components'
import { GifGrid, Header, SearchBar, SearchHistory, ResultsCallout } from '@/components'
import { GlobalStyles, theme } from '@/styles/global.styles'
import { GifContext } from '@/providers'
import { normalizeGiphyResponse } from '@/utils'
import { GIPHY_API_BASE, GIPHY_API_KEY } from '@/constants'

const GiphyHead = () => (
  <Head>
    <title>GIPHY GRABBER</title>
    <meta name='description' content='Generated by create next app' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='/favicon.ico' />
    <link href='https://fonts.cdnfonts.com/css/lato' rel='stylesheet' />
  </Head>
)

export default function Home({ gifs }) {
  return (
    <ThemeProvider theme={theme}>
      <GlobalStyles />
      <GiphyHead />
      <GifContext.Provider initialState={gifs}>
        <main>
          <Header />
          <SearchBar />
          <SearchHistory />
          <ResultsCallout />
          <GifGrid />
        </main>
      </GifContext.Provider>
    </ThemeProvider>
  )
}

Home.getInitialProps = async ctx => {
  const { q, page } = ctx.req.query ?? {}
  const trendingUrl = `${GIPHY_API_BASE}/trending?api_key=${GIPHY_API_KEY}&limit=25&rating=pg-13&offset=${page}`
  const searchUrl = `${GIPHY_API_BASE}/search?api_key=${GIPHY_API_KEY}&q=${q}&offset=${page}&limit=20&rating=pg-13&lang=en`

  const fetchResponse = await fetch(q ? trendingUrl : searchUrl, { cache: 'no-store' })
  const gifs = await fetchResponse.json()
  return { gifs: normalizeGiphyResponse(gifs) }
}
